name: Copilot Integration
on:
  pull_request:
    types: [opened, synchronize]

jobs:
  copilot:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Set up Node.js
      uses: actions/setup-node@v2
      with:
        node-version: '18'

    - name: Install Copilot CLI
      run: |
        npm install -g @githubnext/github-copilot-cli
        echo "Node.js version:"
        node -v
        echo "NPM version:"
        npm -v
        # Correctly add npm global bin to PATH
        NPM_GLOBAL_BIN=$(npm bin -g)
        echo $NPM_GLOBAL_BIN >> $GITHUB_PATH
        export PATH=$NPM_GLOBAL_BIN:$PATH
        echo "PATH after adding npm global bin:"
        echo $PATH
        echo "Contents of npm global bin directory:"
        ls -la $NPM_GLOBAL_BIN
        echo "Installed Copilot CLI version:"
        copilot --version || echo "Copilot CLI not found"
      
    - name: Fetch main branch
      run: |
        git fetch origin main
        
    - name: Extract PR Code
      run: |
        git fetch origin pull/${{ github.event.pull_request.number }}/head:pr-${{ github.event.pull_request.number }}
        git diff origin/main pr-${{ github.event.pull_request.number }} > pr_diff.txt

    - name: Send to Copilot
      run: |
        copilot --file pr_diff.txt --prompt "Here is some code from a pull request. Please provide a review and suggestions for improvement:" > copilot_response.txt

    - name: Comment on Pull Request
      uses: peter-evans/create-or-update-comment@v1
      with:
        issue-number: ${{ github.event.pull_request.number }}
        body: |
          Copilot Response: $(cat copilot_response.txt)
